# Sub-Environment Automation Guide

## 🎯 **Overview**

This document describes the automated sub-environment management system that allows you to deploy isolated environments for any branch matching the wildcard patterns (`dev*`, `qa*`, `staging*`, `hotfix*`).

## 🚀 **How It Works**

### **1. Automatic Workspace Management**

- When you push to a branch like `dev04`, `qa02`, or `staging03`, the workflow automatically:
  - Creates a Terraform workspace named after the branch (e.g., `dev04`)
  - Selects the workspace for deployment
  - Manages the workspace lifecycle

### **2. Automatic tfvars Generation**

- Generates environment-specific tfvars files from a template
- Includes all required variables (ECR URLs, image tags, environment names)
- Uses commit SHA for image versioning

### **3. Automatic Cleanup**

- When you delete a branch, the cleanup workflow automatically:
  - Destroys the infrastructure
  - Deletes the Terraform workspace
  - Removes the tfvars file
  - Cleans up ECS services

## 📋 **Branch Patterns Supported**

| Branch Pattern | Environment | Example Branches        | Domain Pattern                               |
| -------------- | ----------- | ----------------------- | -------------------------------------------- |
| `dev*`         | Development | `dev`, `dev01`, `dev02` | `dev.hibiji.com`, `dev01.hibiji.com`         |
| `qa*`          | QA          | `qa`, `qa01`, `qa02`    | `qa.hibiji.com`, `qa01.hibiji.com`           |
| `staging*`     | Staging     | `staging`, `staging01`  | `staging.hibiji.com`, `staging01.hibiji.com` |
| `hotfix*`      | Hotfix      | `hotfix`, `hotfix01`    | `hotfix.hibiji.com`, `hotfix01.hibiji.com`   |

## 🔄 **Deployment Flow**

### **For New Sub-Environments (e.g., `dev04`)**

1. **Create Branch**: `git checkout -b dev04`
2. **Push Code**: `git push origin dev04`
3. **Automatic Deployment**:
   - Workflow creates workspace `dev04`
   - Generates `dev04.auto.tfvars`
   - Deploys infrastructure to `dev04.hibiji.com`
4. **Access**: Visit `https://dev04.hibiji.com`

### **For Existing Sub-Environments**

1. **Push Changes**: `git push origin dev04`
2. **Automatic Update**:
   - Workflow selects existing workspace `dev04`
   - Updates infrastructure with new code
   - Zero-downtime deployment

### **For Cleanup**

1. **Delete Branch**: `git push origin --delete dev04`
2. **Automatic Cleanup**:
   - Destroys infrastructure
   - Deletes workspace
   - Removes tfvars file
   - Cleans up ECS services

## 📁 **File Structure**

```
terraform/environments/
├── tfvars.template                    # Template for generating tfvars files
├── dev/
│   ├── main.tf                       # Dev environment configuration
│   ├── dev.auto.tfvars               # Main dev environment variables
│   ├── dev01.auto.tfvars             # Auto-generated for dev01
│   ├── dev02.auto.tfvars             # Auto-generated for dev02
│   └── .terraform/                   # Terraform state and workspaces
├── qa/
│   ├── main.tf                       # QA environment configuration
│   └── .terraform/                   # Terraform state and workspaces
└── staging/
    ├── main.tf                       # Staging environment configuration
    └── .terraform/                   # Terraform state and workspaces
```

## 🔧 **Generated tfvars File Example**

When you push to `dev04`, this file is automatically generated:

```hcl
# Auto-generated for sub-environment: dev04
# Generated on: 2025-01-11T15:30:45Z
# Branch: dev04

environment     = "dev"
sub_environment = "dev04"
domain_name     = "hibiji.com"

# ECR Repository URLs
# ECR Repository URLs are created dynamically by Terraform
# No hardcoded values needed - URLs constructed from AWS account ID, region, and project name
# Example format: {account-id}.dkr.ecr.{region}.amazonaws.com/{project-name}-{service}

# Image tags (using commit SHA for versioning)
image_tag                  = "a1b2c3d4e5f6"
frontend_image_tag         = "a1b2c3d4e5f6"
```

## 🛠️ **Manual Management**

### **List All Sub-Environments**

```bash
# List all workspaces in dev environment
cd terraform/environments/dev
terraform workspace list

# List all workspaces in qa environment
cd terraform/environments/qa
terraform workspace list
```

### **Manual Cleanup**

```bash
# Switch to specific workspace
cd terraform/environments/dev
terraform workspace select dev04

# Destroy infrastructure
terraform destroy -var="sub_environment=dev04"

# Delete workspace
terraform workspace select default
terraform workspace delete dev04

# Remove tfvars file
rm dev04.auto.tfvars
```

### **Check Infrastructure Status**

```bash
# Check ECS services
aws ecs list-services --cluster hibiji-dev-cluster --region us-west-1

# Check specific service
aws ecs describe-services \
  --cluster hibiji-dev-cluster \
  --services hibiji-dev04-backend \
  --region us-west-1
```

## 🔍 **Monitoring and Debugging**

### **Workflow Logs**

- **Deploy Workflow**: Check `.github/workflows/deploy.yml` logs
- **Cleanup Workflow**: Check `.github/workflows/cleanup-subenv.yml` logs
- **CI Workflow**: Check `.github/workflows/ci.yml` logs

### **Common Issues**

1. **Workspace Already Exists**: Workflow will select existing workspace
2. **Tfvars File Exists**: Workflow will use existing file (won't overwrite)
3. **Infrastructure Already Deployed**: Workflow will update existing resources
4. **Cleanup Fails**: Check AWS permissions and manually clean up if needed

### **Debug Commands**

```bash
# Check workspace status
terraform workspace show

# List all workspaces
terraform workspace list

# Check tfvars file
cat terraform/environments/dev/dev04.auto.tfvars

# Check ECS cluster status
aws ecs describe-clusters --clusters hibiji-dev-cluster --region us-west-1
```

## 🚨 **Important Notes**

### **Cost Considerations**

- Each sub-environment creates its own infrastructure
- Monitor costs and clean up unused environments
- Consider setting up cost alerts per environment

### **Resource Limits**

- AWS account quotas apply (VPCs, subnets, ECS services, etc.)
- Monitor resource usage and clean up regularly
- Consider implementing resource limits in Terraform

### **Security**

- Each sub-environment is isolated
- Use different secrets per environment if needed
- Monitor access logs and security groups

## 📊 **Best Practices**

1. **Naming Convention**: Use consistent branch naming (`dev01`, `dev02`, etc.)
2. **Regular Cleanup**: Delete branches when no longer needed
3. **Monitor Costs**: Set up cost alerts and budgets
4. **Test in Sub-Environments**: Use sub-environments for feature testing
5. **Document Changes**: Update this guide when making changes

## 🔗 **Related Files**

- `.github/workflows/deploy.yml` - Main deployment workflow
- `.github/workflows/cleanup-subenv.yml` - Cleanup workflow
- `.github/workflows/ci.yml` - CI workflow with workspace support
- `terraform/environments/tfvars.template` - Tfvars template
- `scripts/manage-sub-environments.sh` - Manual management script

---

**Status**: ✅ **IMPLEMENTED**  
**Last Updated**: January 2025  
**Version**: 1.0
